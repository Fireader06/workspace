<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ball Library</title>
    <link rel="stylesheet" href="ball-styles.css" />
  </head>

  <body>
    <!-- Shared ticker -->
    <div class="news-ticker">
      <div class="ticker-content" id="ticker"></div>
    </div>

    <!-- Shared ticker script -->
    <script src="ticker.js"></script>

    <header>
      <h1>Ball Library</h1>
    </header>

    <main>
      <div id="balls-container" aria-live="polite"></div>
    </main>
    <main>
      <div id="balls-container" aria-live="polite"></div>

      <div id="new-ball-creator">
        <h2>Create a New Ball</h2>
        <textarea
          id="ball-prompt"
          placeholder="Describe your ball idea..."
        ></textarea>
        <button id="send-to-ai">Generate Ball</button>
        <p id="status"></p>
        <div
          id="response-log"
          style="
            margin-top: 15px;
            padding: 10px;
            background: #111;
            color: #0f0;
            white-space: pre-wrap;
            font-family: monospace;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #333;
          "
        ></div>
      </div>
    </main>

    <!-- Modal -->
    <div id="info-overlay">
      <div class="info-box">
        <h2 id="info-title"></h2>
        <p id="info-text"></p>
        <button id="close-overlay">Close</button>
      </div>
    </div>

    <script src="data.js"></script>
    <script>
      const container = document.getElementById("balls-container");
      const overlay = document.getElementById("info-overlay");
      const infoTitle = document.getElementById("info-title");
      const infoText = document.getElementById("info-text");
      const closeOverlay = document.getElementById("close-overlay");

      if (Array.isArray(jsonData)) {
        jsonData.forEach((ball) => {
          const card = document.createElement("div");
          card.className = "ball-card";

          const img = document.createElement("div");
          img.className = "ball-gradient";
          img.style.background =
            ball.gradient || "linear-gradient(135deg, #999, #555)";

          const name = document.createElement("h2");
          name.textContent = ball.name;

          card.append(img, name);
          container.appendChild(card);

          // Modal on click
          card.addEventListener("click", () => {
            infoTitle.textContent = ball.name;

            let statsHTML = "";

            if (ball.stats) {
              const s = ball.stats;
              const baseStats = [];
              if (s.damage !== undefined) baseStats.push(`Damage: ${s.damage}`);
              if (s.knockback !== undefined)
                baseStats.push(`Knockback: ${s.knockback}`);
              if (s.pierce !== undefined) baseStats.push(`Pierce: ${s.pierce}`);

              const effectGroups = [];
              if (s.poison) {
                const durationText = s.duration
                  ? ` â€¢ Duration: ${s.duration}`
                  : "";
                effectGroups.push(
                  `<div class="effect-group"><strong>Poison:</strong>${durationText}</div>`
                );
              }

              const miscEffects = [];
              if (s.areaEffect) miscEffects.push("Area Effect");
              if (s.slow) miscEffects.push("Slow");
              if (s.heal) miscEffects.push("Heal");
              if (s.burn) miscEffects.push("Burn");
              if (s.freeze) miscEffects.push("Freeze");
              if (s.shock) miscEffects.push("Shock");

              statsHTML = `
                <div class="stats-block">
                  ${
                    baseStats.length
                      ? `<p><strong>Stats:</strong><br>${baseStats.join(
                          "<br>"
                        )}</p>`
                      : ""
                  }
                  ${
                    effectGroups.length
                      ? `<div class="effects-section">${effectGroups.join(
                          ""
                        )}</div>`
                      : ""
                  }
                  ${
                    miscEffects.length
                      ? `<div class="misc-section"><strong>Other Effects:</strong><ul>${miscEffects
                          .map((e) => `<li>${e}</li>`)
                          .join("")}</ul></div>`
                      : ""
                  }
                </div>
              `;
            }

            infoText.innerHTML = `
              <p>${ball.description}</p>
              <p><strong>Ability:</strong> ${ball.ability}</p>
              ${statsHTML}
            `;
            overlay.style.display = "flex";
          });
        });
      }

      closeOverlay.addEventListener(
        "click",
        () => (overlay.style.display = "none")
      );
      overlay.addEventListener("click", (e) => {
        if (e.target === overlay) overlay.style.display = "none";
      });
    </script>
    <script>
      const API_URL =
        "https://reporters-guarantee-craft-cancel.trycloudflare.com/v1/chat/completions";
      // ðŸ‘† must include /v1/chat/completions

      const createBtn = document.getElementById("send-to-ai");
      const promptBox = document.getElementById("ball-prompt");
      const statusBox = document.getElementById("status");

      function logResponse(text) {
        const box = document.getElementById("response-log");
        box.textContent += text + "\n\n-----------------------\n\n";
        box.scrollTop = box.scrollHeight;
      }

      async function createBallWithAI() {
        const userPrompt = promptBox.value.trim();
        if (!userPrompt) {
          alert("Please describe your ball first!");
          return;
        }

        statusBox.innerHTML = "ðŸŸ¡ Sending request...";
        createBtn.disabled = true;

        const systemPrompt = `
    You are an assistant that designs game balls for a fantasy ball library.
    Return your answer in **pure JSON only**.
    Where it says "number" put actual numbers, not words.
    There is NOTHING in this game excpet balls, so don't try to add anything extra.
    Do not put any extra efects, all efects are put down as a boolean in the example.
    Each ball has:
    {
      "name": "string",
      "description": "string",
      "ability": "string",
      "gradient": "linear-gradient(...)",
      "stats": {
        "damage": number,
        "burn": boolean,
        "freeze": boolean,
        "shock": boolean,
        "poison": boolean,
        "slow": boolean,
        "heal": boolean,
        "knockback": number,
        "pierce": number,
        "areaEffect": boolean,
        "duration": number
      }
      Here is the example starter ball from the game, 
      {
    name: "StarterBall",
    description:
      "A simple, balanced orb that serves as the foundation for all others.",
    ability: "Bounce",
    gradient:
      "radial-gradient(circle at 30% 30%, hsl(220, 20%, 85%), hsl(220, 15%, 65%))",
    stats: {
      damage: 25,
      burn: false,
      freeze: false,
      shock: false,
      poison: false,
      slow: false,
      heal: false,
      knockback: 5,
      pierce: 1,
      areaEffect: false,
      duration: 2,
    }
    another example,
    {
    name: "AetherBall",
    description:
      "A radiant orb infused with celestial energy that restores and empowers allies.",
    ability: "Renew",
    gradient:
      "radial-gradient(circle at 30% 30%, hsl(280, 70%, 80%), hsl(320, 60%, 55%))",
    stats: {
      damage: 20,
      burn: false,
      freeze: false,
      shock: false,
      poison: false,
      slow: false,
      heal: true,
      knockback: 0,
      pierce: 0,
      areaEffect: true,
      duration: 10,
    }
    }`;

        const payload = {
          model: "YourModelNameHere", // ðŸ‘ˆ use model name from /v1/models endpoint
          messages: [
            { role: "system", content: systemPrompt },
            { role: "user", content: userPrompt },
          ],
          temperature: 0.8,
          max_tokens: 300,
        };

        try {
          const response = await fetch(API_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer EMPTY", // ðŸ‘ˆ required for OpenAI API spec
            },
            body: JSON.stringify(payload),
          });

          const text = await response.text();
          logResponse("[RAW RESPONSE]\n" + text);

          let data;
          try {
            data = JSON.parse(text);
          } catch {
            throw new Error("Invalid JSON returned from API: " + text);
          }

          const message = data.choices?.[0]?.message?.content;
          if (!message)
            throw new Error("No message content found in response!");

          logResponse("[MODEL MESSAGE]\n" + message);

          let ball;
          try {
            // ðŸ§¹ Clean markdown fences and extract only the JSON object
            const jsonMatch = message.match(/\{[\s\S]*\}/);
            if (!jsonMatch)
              throw new Error("No JSON object found in model response.");

            const clean = jsonMatch[0];
            ball = JSON.parse(clean);
          } catch (e) {
            throw new Error(
              "Model output was not valid JSON: " +
                e.message +
                "\nRaw: " +
                message
            );
          }

          addBallToLibrary(ball);
          statusBox.innerHTML = "âœ… Ball added successfully!";
          promptBox.value = "";
        } catch (err) {
          logResponse("[BALL-ERROR]\n" + err.message);
          statusBox.innerHTML = `âŒ Error: ${err.message}`;
        } finally {
          createBtn.disabled = false;
        }
      }

      createBtn.addEventListener("click", createBallWithAI);

      function addBallToLibrary(ball) {
        const container = document.getElementById("balls-container");
        const card = document.createElement("div");
        card.className = "ball-card";

        const img = document.createElement("div");
        img.className = "ball-gradient";
        img.style.background =
          ball.gradient || "linear-gradient(135deg, #999, #555)";

        const name = document.createElement("h2");
        name.textContent = ball.name;

        card.append(img, name);
        container.appendChild(card);

        // Unified stats renderer
        card.addEventListener("click", () => {
          infoTitle.textContent = ball.name;

          let statsHTML = "";
          if (ball.stats) {
            const s = ball.stats;

            const baseStats = [];
            if (s.damage !== undefined) baseStats.push(`Damage: ${s.damage}`);
            if (s.knockback !== undefined)
              baseStats.push(`Knockback: ${s.knockback}`);
            if (s.pierce !== undefined) baseStats.push(`Pierce: ${s.pierce}`);

            const effectGroups = [];
            if (s.poison) {
              effectGroups.push(
                `<div class="effect-group">
                  <strong>Poison:</strong>${
                    s.duration ? ` â€¢ Duration: ${s.duration}` : ""
                  }
                </div>`
              );
            }

            const miscEffects = [];
            if (s.areaEffect) miscEffects.push("Area Effect");
            if (s.slow) miscEffects.push("Slow");
            if (s.heal) miscEffects.push("Heal");
            if (s.burn) miscEffects.push("Burn");
            if (s.freeze) miscEffects.push("Freeze");
            if (s.shock) miscEffects.push("Shock");

            statsHTML = `
              <div class="stats-block">
                ${
                  baseStats.length
                    ? `<p><strong>Stats:</strong><br>${baseStats.join(
                        "<br>"
                      )}</p>`
                    : ""
                }
                ${
                  effectGroups.length
                    ? `<div class="effects-section">${effectGroups.join(
                        ""
                      )}</div>`
                    : ""
                }
                ${
                  miscEffects.length
                    ? `<div class="misc-section"><strong>Other Effects:</strong><ul>${miscEffects
                        .map((e) => `<li>${e}</li>`)
                        .join("")}</ul></div>`
                    : ""
                }
              </div>
            `;
          }

          infoText.innerHTML = `
            <p>${ball.description}</p>
            <p><strong>Ability:</strong> ${ball.ability}</p>
            ${statsHTML}
          `;

          overlay.style.display = "flex";
        });
      }
    </script>
  </body>
</html>
